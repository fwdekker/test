on: [push]
jobs:
  netbsd-job:
    strategy:
      matrix:
        sync: ["no", "rsync", "sshfs", "scp"]
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: vmactions/netbsd-vm@main
        with:
          sync: ${{ matrix.sync }}
          run: |
            set -e

            printf "::group::Without buildinfo (works fine)\n"
            ls -lah
            touch ./contents

            /usr/sbin/pkg_create \
              -c -"My comment" \
              -d -"My description" \
              -f ./contents \
              my-package.tgz
            ls -lah
            
            rm ./contents ./my-package.tgz
            printf "::endgroup::\n"


            printf "::group::With empty buildinfo (fails)\n"
            ls -lah
            touch ./contents ./buildinfo

            /usr/sbin/pkg_create \
              -B ./buildinfo \
              -c -"My comment" \
              -d -"My description" \
              -f ./contents \
              my-package.tgz
            ls -lah
            
            rm ./contents ./buildinfo ./my-package.tgz
            printf "::endgroup::\n"


            printf "::group::With non-empty buildinfo (fails)\n"
            ls -lah
            touch ./contents
            printf "MACHINE_ARCH=%s\n" "$(uname -p)"             > "./buildinfo"
            printf "OPSYS=%s\n" "$(uname)"                      >> "./buildinfo"
            printf "OS_VERSION=%s\n" "$(uname -r)"              >> "./buildinfo"
            printf "PKGTOOLS_VERSION=%s\n\n" "$(pkg_create -V)" >> "./buildinfo"

            /usr/sbin/pkg_create \
              -B ./buildinfo \
              -c -"My comment" \
              -d -"My description" \
              -f ./contents \
              my-package.tgz
            ls -lah

            rm ./contents ./buildinfo ./my-package.tgz
            printf "::endgroup::\n"
